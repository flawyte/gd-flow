#!/bin/bash


# ---------- HEADER (gives you some informations)
# This work is licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/3.0/ or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.
#
# Name : gd-flow (stands for Git Deployment Flow)
# Description : gdflow is a little bash script that allows you to automate deployment using Git and the rsync command only.
# Project page : https://github.com/inspirat/gd-flow
# Version : 1.1
# Parameters :
#       * $1 : Path to the local git repository that triggered the hook
#       * $2 : Destination directory - where to deploy the files
#       * $3 [Optional] : File containing patterns to exclude from the synchronization - See the "INCLUDE/EXCLUDE PATTERN RULES" part at "http://rsync.samba.org/ftp/rsync/rsync.html"
#
# WARNING : Don't forget to chmod +x the script so it can be triggered by Git.


# ---------- VARIABLES (what you have to modify)

DEST_DIR=$2
EXCLUDE_FILE=/dev/null # will not exclude any file or directory
GIT_DIR=$1
TEMP_DIR="$DEST_DIR-temp"

if [ $# == 3 ] ;
then
        EXCLUDE_FILE=$3
fi


# ---------- OPERATIONS (what you can ignore)

# Creates the temporary directory
mkdir $TEMP_DIR

# Creates the files in the temporary directory by doing a hard reset
git --git-dir=$GIT_DIR --work-tree=$TEMP_DIR reset --hard HEAD

# Updates the content of the destination directory by using synchronization
rsync -a --delete --exclude-from=$EXCLUDE_FILE --progress -r -v $TEMP_DIR $DEST_DIR

# Removes the temporary directory and its content
rm -rf $TEMP_DIR
